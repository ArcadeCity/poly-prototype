<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/leaflet-map/leaflet-map.html">
<link rel="import" href="../bower_components/ac-icon/ac-icon.html">

<script src="../bower_components/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<dom-module id="ac-locationpicker">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
      :host {
        display: block;
      }

      leaflet-map {
        height: 100vh;
      }

      .spinnerdiv {
        height: 100vw;
      }
    </style>

    <div hidden="{{locationbound}}" class="spinnerdiv">
      <ac-icon class="refresher" icon="refresh1" iconcolor="yellow"></ac-icon>
    </div>

    <leaflet-map
      id="leaflet"
      draggable="true"
      zoom="{{zoom}}"
      latitude="{{latitude}}"
      longitude="{{longitude}}"
      no-Zoom-Control="true"
      min-zoom="8"
      max-zoom="19"
      on-map-ready="mapready"
      hidden="{{!locationbound}}">
      <template is="dom-if" if="{{dogeolocation}}">
        <leaflet-geolocation
          on-locationfound="locationfound"
          enable-high-accuracy
          latitude="{{latitude}}"
          longitude="{{longitude}}"
          accuracy="3">
        </leaflet-geolocation>
      </template>

      <leaflet-tilelayer
        url="//1.base.maps.cit.api.here.com/maptile/2.1/maptile/newest/normal.day/{z}/{x}/{y}/256/png8?app_id=s6z9incVaWY1oE3SoBol&app_code=iJKI11eGupM_wnz2_EQ2Kg" max-zoom="19">
      </leaflet-tilelayer>

    </leaflet-map>

  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'ac-locationpicker',

      properties: {
        locationbound: {
          type: Boolean,
          value: false,
          notify: true
        },
        zoom: {
          type: Number,
          value: 17
        },
        resolvedAddress: {
          type: Object,
          notify: true
        },
        currentGeo: {
          type: Object,
          notify: true
        },
        latitude: {
          type: Number,
          observer: 'initmap'
        },
        longitude: {
          type: Number,
          observer: 'initmap'
        },
        dogeolocation: {
          type: Boolean,
          value: false
        },
        displayaddress: {
          type: String,
          notify: true
        }
      },

      mapready: function(){
        // try to init the map with given lat/lon
        // when we arrive here, the attach event is passed already.
        this.initmap();
        // if nothing was inited now - the lat/lng were not given.
        // so enable our own geolocation component
        if (!this.inited){
          console.log('ac-locationpicker -> no lat/lng given - DIY');
          this.dogeolocation = true;
        }
      },


      initmap: function(){
        // only execute once
        if (this.inited){
          return;
        }
        // check of lat/lng were given as attributes to this component
        // and if so - set the map to this location & add the marker etc.
        if (this.latitude && this.longitude && this.$.leaflet.map) {
          console.log('ac-locationpicker -> starting on location',this.latitude, this.longitude);
          this.setmapgeo(this.latitude,this.longitude);
          // and mark the component as started
          this.inited = true;
        }
      },

      setcurrentGeo: function(lat, lng) {
        this.currentGeo = {
          'lat': lat,
          'lng': lng
        };
        this.fire('geo-set', {'display_address': this.displayaddress, 'address': this.resolvedAddress })

      },

      // this triggers when DIY geolocation is done
      locationfound: function(e) {
        // if lat/lng was supplied , ignore own geolocation...
        // if (this.latitude && this.longitude){
        //   return;
        // }
        this.setmapgeo(e.detail.latitude,e.detail.longitude);
      },

      setmapgeo: function(lat,lon){
        this.$.leaflet.map.invalidateSize();
        this.$.leaflet.map.addEventListener('moveend', function() {
          this.$.leaflet.map.invalidateSize();
        }.bind(this));
        this.locationbound = true;
        this.setcurrentGeo(lat, lon);
        var self = this;
        this.getAddress(this.currentGeo).then(function(response) {
          self.resolvedAddress = JSON.parse(response);
          self.displayaddress = self.resolvedAddress.display_name;
        }, function(error) {});
        this.appendMarker(lat, lon);
      },

      appendMarker: function(lat, lng) {
        marker = document.createElement('leaflet-marker');
        marker.latitude = lat;
        marker.longitude = lng;
        marker.draggable = "true";
        var self = this;
        //this.setmapgeo(lat, lng);
        marker.addEventListener('dragend', function(e) {
          this.getAddress(e.detail.target._latlng).then(function(response) {
            self.resolvedAddress = JSON.parse(response);
            self.displayaddress = self.resolvedAddress.display_name;
            self.fire('dragend', {
              'resolvedaddress': response,
              'lat': e.detail.target._latlng.lat,
              'lng': e.detail.target._latlng.lng
            });

            self.setcurrentGeo(e.detail.target._latlng.lat, e.detail.target._latlng.lng);
          }, function(error) {
            self.fire('error', error);
          });
        }.bind(this));
        this.$.leaflet.appendChild(marker);
      },

      getAddress: function(latlng) {
        this.$.leaflet.map.setView([latlng.lat, latlng.lng], this.zoom);
        var lat = latlng.lat;
        var lng = latlng.lng;
        var options = 'format=json&lat='+lat+'&lon='+lng+'&zoom=18&addressdetails=1';
        var url = '//nominatim.openstreetmap.org/reverse?' + options;

        // Return a new promise.
        return new Promise(function(resolve, reject) {
          // Do the usual XHR stuff
          var req = new XMLHttpRequest();
          req.open('GET', url);

          req.onload = function() {
            // This is called even on 404 etc
            // so check the status
            if (req.status == 200) {
              // Resolve the promise with the response text
              resolve(req.response);
            }
            else {
              // Otherwise reject with the status text
              // which will hopefully be a meaningful error
              reject(Error(req.statusText));
            }
          };

          // Handle network errors
          req.onerror = function() {
            reject(Error("Network Error"));
          };

          // Make the request
          req.send();
        });
      }


    });
  </script>

</dom-module>
