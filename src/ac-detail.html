<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./ac-blockdata.html">
<link rel="import" href="./ac-button.html">
<link rel="import" href="../bower_components/ac-style/ac-style.html">
<link rel="import" href="./ac-ipfs.html">

<dom-module id="ac-detail">
  <!-- Defines the element's style and local DOM -->
  <template>
  <style>
    :host {
      display: block;
      width: 100%;
      --offeramount-size: 46px;
      --offeramount-lineheight: 52px;
      --address-size:20px;
      --address-lineheight:25px;
      --flex-align1:end;
      --flex-align2:flex-end;
      @apply(--base-structure);
    }


    h1 {
      @apply(--ac-font-h1);
    }
    h2 {
      @apply(--ac-font-h2);
    }
    h3 {
      @apply(--ac-font-h3);
    }
    p {
      @apply(--ac-font-body1);
    }


    .topbar {
      width: 100%;
      height: 12vh;
      /*height: var(--topbar-height);*/
      @apply(--layout-horizontal);
      @apply(--layout-center);
      box-sizing: border-box;
      padding: 10px 20px 0px 25px;
      @apply(--base-structure);
      border-bottom:1px solid transparent;
    }

    .flex {
      @apply(--layout-horizontal);
      @apply(--layout-flex);
    }

    .main {
      overflow-y: scroll;
      height: 88vh;
      width: 100%;
      @apply(--base-structure);

    }

    .content {
      width: 100%;
      @apply(--layout-vertical);
      @apply(--layout-center);
      @apply(--base-structure);
    }


    .offercard {
      background-color: var(--ac-base);
      width: 100%;
      box-sizing: border-box;
/*        padding: 30px 8vw 20px 8vw;
      border-bottom: 1px solid rgba(0,0,0,0.25);*/
      @apply(--layout-horizontal);
      /*@apply(--layout-end);*/
      @apply(--layout-start-justified);
      border:1px solid var(--ac-base);

      -ms-flex-align: var(--flex-align1);
      -webkit-align-items: var(--flex-align2);

    }


    .offercontent {
      @apply(--layout-vertical);
      @apply(--layout-start);
      @apply(--layout-start-justified);
      @apply(--layout-flex);
      box-sizing: border-box;
      padding: 20px 20px 20px 20px;
      border-right:2px dotted var(--ac-base);
      width: 70%;
      color: white;
    }

    .offercontenttxt {
      @apply(--layout-horizontal);
      @apply(--layout-start);
      @apply(--layout-start-justified);
      height: 100%;
      box-sizing: border-box;
      margin-top: 7px;
      width: 100%;
    }

    .offercontenttxt p {
      font-size: 20px;
      line-height: 25px;
    }

    .offerer {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    .offereravatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      overflow: hidden;
      background-color: rgba(0,0,0,0.25);
    }


    .offereravatar img {
      width: 100%;
      height: 100%;
    }


    .myoffereravatar {
      width: 35px;
      height: 35px;
      min-width: 35px;
      min-height: 35px;
      border-radius: 50%;
      overflow: hidden;
      background-color: rgba(0,0,0,0.25);
      border: 1px solid var(--ac-red);
    }
    .myoffereravatar img {
      width: 100%;
      height: 100%;
    }


    .offerername {
      margin: 0px 0px 0px 10px;
    }

    .offerername p {
      @apply(--montserrat-ultralight);
      /*color: var(--ac-green);*/
      color: rgba(255,255,255,0.5);

/*        font-size: 14px;
      line-height: 17px;*/
    }

    .myofferername {
      margin: 0px 0px 0px 15px;
    }
    .myofferername p {
      @apply(--montserrat-ultralight);
      color: rgba(255,255,255,0.5);
    }

    .iamofferer {
      @apply(--montserrat-light);
      color: var(--ac-base);
      background-color: rgba(255,255,255,0.2);
      box-sizing: border-box;
      padding: 2px 4px 2px 4px;
      border-radius: 2px;

/*        font-size: 14px;
      line-height: 17px;*/
    }



    .offeramount {
      @apply(--layout-horizontal);
      @apply(--layout-end);
      @apply(--layout-end-justified);
      height: 100%;
      box-sizing: border-box;
      padding: 20px 20px 20px 20px;
      width: 30%;
    }


    .offeramountmobile {
      @apply(--layout-vertical);
      @apply(--layout-end);
      @apply(--layout-end-justified);
      height: 100%;
      box-sizing: border-box;
      padding: 20px 20px 20px 20px;
      width: 30%;
    }


    .offeramount h1 {
      color: var(--ac-red);
      @apply(--montserrat-ultralight);
      margin: 0px;
      font-size: 46px;
      line-height: 52px;
    }
    .offeramount p {
      color: var(--ac-red);
      font-size: 16px;
      line-height: 34px;
      margin: 0px;
    }


    .offeramountmobile h1 {
      color: var(--ac-red);
      @apply(--montserrat-ultralight);
      margin: 0px;
      font-size: 30px;
      line-height: 34px;
    }
    .offeramountmobile p {
      color: var(--ac-red);
      font-size: 16px;
      line-height: 20px;
      margin: 0px;
    }

    .address {
      /*@apply(--ac-fonts-nowrap);*/
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .address p {
      font-size: var(--address-size);
      line-height: var(--address-lineheight);
    }

    .needride {
      width: 50%;
    }

    .drivers {
      font-size: 12px;
      color: var(--ac-blue);
    }

    .currentkarma {
      @apply(--montserrat-reg);
    }





    .offercontent_detail {
      @apply(--layout-vertical);
      @apply(--layout-center-center);
      box-sizing: border-box;
      padding: 0px 20px 20px 20px;
      width: 100%;
      color: white;
    }


    .offeramount_detail {
      @apply(--layout-horizontal);
      @apply(--layout-end);
      @apply(--layout-start-justified);
      margin-top: 30px;
/*        box-sizing: border-box;
      padding: 0px 20px 20px 20px;*/
    }

    .claimer {
      margin-top: 30px;
    }

    .claimer p {
      @apply(--montserrat-reg);
      color: var(--ac-red);
      opacity: 0.5
    }

    .offeramount_detail h1 {
      color: var(--ac-red);
      @apply(--montserrat-ultralight);
      margin: 0px;
      font-size: var(--offeramount-size);
      line-height: var(--offeramount-lineheight);
    }
    .offeramount_detail p {
      color: var(--ac-red);
      font-size: 16px;
      line-height: 34px;
      margin: 0px;
    }

    .offercontenttxt_detail {
      @apply(--layout-vertical);
      @apply(--layout-start);
      @apply(--layout-start-justified);
      box-sizing: border-box;
      margin: 40px 10vw 20px 10vw;
      width: 80%;
    }

    .offercontenttxt_detail p {
      font-size: 18px;
      line-height: 24px;
      text-align: left;
    }

    .detail_addresses {
      font-size: 22px;
      line-height: 25px;
    }


    .offerer_detail {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-start-justified);
      width: 80%;
    }

    .offerername_detail {
      @apply(--layout-vertical);
      @apply(--layout-start);
      @apply(--layout-start-justified);
      margin: 0px 0px 0px 20px;
      /*color: var(--ac-green);*/
      color: rgba(255,255,255,0.5);
    }

    .offereravatar_detail {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      background-color: rgba(0,0,0,0.25);
    }

    .offereravatar_detail img {
      width: 100%;
      height: 100%;
    }

    .pickmeup {
      font-size: 16px;
      line-height: 22px;
      color: var(--ac-turquoise);
    }

    .amountandclaimer {
      width: 80%;
      margin:30px 10vw 40px 10vw;
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-start-justified);

      @apply(--layout-wrap);

      border-top: 1px dashed rgba(255,255,255,0.25);
      box-sizing: border-box;
    }




    .centeredtxt {
      text-align: center;
    }
    .someheight {
      height: 60vh;
    }
    .certainwidth {
      width: 70%;
    }

    .smalltxt {
      font-size: 12px;
      line-height: 16px;
      color:var(--ac-turquoise);
    }

    .whitespace {
      height: 20px;
    }
.refresher {
     -webkit-animation-name: rotate;
    -webkit-animation-duration: 1s;
    -webkit-animation-iteration-count: infinite;
    -webkit-animation-timing-function: linear;
    -moz-animation-name: rotate;
    -moz-animation-duration: 1s;
    -moz-animation-iteration-count: infinite;
    -moz-animation-timing-function: linear;
    animation-name: rotate;
    animation-duration: 1s;
    animation-iteration-count: infinite;
    animation-timing-function: linear;
    opacity: 0.5;
   }

    @-webkit-keyframes rotate {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
    }

    @-moz-keyframes rotate {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
    }

    @keyframes rotate {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
    }

  </style>
  <ac-blockdata name="blockdata" blockdata="{{blockdata}}" blockobject="{{blockobject}}"></ac-blockdata>

    <div class="topbar">
     <p class="flex" on-tap="change"></p>
     <ac-button  bg="base" icon="declinenew" on-tap="toHome" small id="exitbtn" txtcolor="turquoise"></ac-button>
   </div>
   <div class="main">
   <div class="content">
     <ac-ipfs id="ipfs"></ac-ipfs>


   <template is="dom-if" if="{{_is(claimstep,'first')}}">

<!--         <div><p>{{data.ipfsdata.object}}</p></div> -->
     <div class="offercontent_detail">

       <div class="offerer_detail">
         <div class="offereravatar_detail">
           <img src="{{imgurl}}">
         </div>
         <div class="offerername_detail">
           <p><span>{{data.ipfsdata.userdata.aka}}</span></p>
           <p><span class="currentkarma">8 karma</span></p>
         </div>
       </div>
<!--
       <div class="offercontenttxt_detail">
           <p>{{status}}</p>
       </div> -->

       <div class="offercontenttxt_detail">
           <p>Need a ride to<br><span class="detail_addresses">{{data.ipfsdata.toaddress.display_name}}</span></p>
           <br>
           <p class="pickmeup">Pick me up at<br><span class="detail_addresses">{{data.ipfsdata.fromaddress.display_name}}</span></p>
       </div>

       <div class="amountandclaimer">
         <div class="offeramount_detail">
           <h1>{{data.ipfsdata.offeramount}}</h1>
           <p>ARC</p>
         </div>
         <span class="flex"></span>

         <template is="dom-if" if="{{_is(status,'added')}}">

         <ac-button class="claimer" txtbtn on-tap="claimOffer" bg="white" txtcolor="red">Claim this offer</ac-button>
         </template>

         <template is="dom-if" if="{{_is(status,'claimed')}}">
           <template is="dom-if" if="{{!thisismyoffer}}">
             <div class="claimer">
               <p>This offer is claimed.</p>
             </div>
           </template>
             <template is="dom-if" if="{{thisismyoffer}}">
               <ac-button class="claimer" txtbtn on-tap="claimOffer" bg="white" txtcolor="red">Release this offer</ac-button>
             </template>
         </template>

         <template is="dom-if" if="{{_is(status,'released')}}">
             <div class="claimer">
               <p>Offer archived.</p>
             </div>
         </template>

         <!-- <template is="dom-if" if="{{_is(status,'claimedbyme')}}">
             <div class="claimer">
               <p>You claimed this offer.</p>
             </div>
         </template> -->



         <!-- <template is="dom-if" if="{{_is(status,'done')}}"> -->
               <!-- <p>This offer is done. This is a receid</p> -->
         <!-- </template> -->

       </div>

     </div>

   </template>


     <template is="dom-if" if="{{_is(claimstep,'second')}}">
       <div class="offercontent_detail someheight centeredtxt certainwidth">

       <p>To claim an offer, you have to match the amount offered.</p>
       <div class="whitespace"></div>
       <ac-button txtbtn on-tap="toThird" bg="red">Match {{data.ipfsdata.offeramount}} ARC</ac-button>
       <div class="whitespace"></div>
       <div class="whitespace"></div>
       <p class="smalltxt">When confirmed by the rider, you will get your tokens back with the reward. If the offer was canceled, you will just get your tokens back.</p>

      <!--  <p on-tap="toThird">
         agree / disagree
       </p> -->

       </div>
     </template>
     <template is="dom-if" if="{{_is(claimstep,'third')}}">
       <div class="offercontent_detail someheight centeredtxt certainwidth">
         <ac-loader small>Sending ARCtokens to offer</ac-loader>
         <div class="whitespace"></div>
         <template is="dom-repeat" items="{{statuslog}}">
           <p>{{item.msg}}</p>
         </template>
         <ac-icon class="refresher" icon="refresh1" iconcolor="yellow"></ac-icon>
       </div>
     </template>
     <template is="dom-if" if="{{_is(claimstep,'fourth')}}">
       <div class="offercontent_detail someheight">
       <h1>Game on!</h1>
<!--         <p>
         [ ] share my live location with the rider
       </p> -->
       <!-- <p on-tap="toHome">
         start driving
       </p> -->
       <div class="whitespace"></div>
       <div class="whitespace"></div>
       <ac-button txtbtn on-tap="toCurrent" bg="turquoise">Start driving</ac-button>
       </div>
     </template>
     </div>
     </div>

<!--
    <ac-button class="claimer" txtbtn on-tap="claimOffer" bg="white" txtcolor="red">Claim this offer</ac-button>

    <ac-button class="claimer" txtbtn on-tap="releaseOffer" bg="red" txtcolor="white">Release this offer</ac-button> -->



  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'ac-detail',
      properties: {
        key: {
          type: Number
        },
        blockdata: {
          type: Array,
          observer: '_loaddata'
        },
        blockobject: {
          type: Object,
          observer: '_loaddata'
        },
        data: {
          type: Object
        },
        claimstep: {
          type: String
        },
        status: {
          type: String,
          observer: '_status'
        }
      },

      attached: function() {
        this.claimstep = 'first';
        this.thisismyoffer = false;
      },

      _status: function() {
        console.log(this.status);
      },

      _loaddata: function() {
        if(this.blockdata && this.blockobject && this.key) {
          this._blockdata();
          this._blockobject();
        }
      },

      _blockdata: function() {
        this.data = this.blockdata[this.blockobject[this.key]];
      },

      _blockobject: function() {
        if(this.blockdata){
        this.data = this.blockdata[this.blockobject[this.key]];
        //this.data = this.blockdata[this.data.offerid];
        this.imgurl = this.$.ipfs.geturl(this.data.ipfsdata.userdata.avatar);
        if(app.helpers.fixaddress(app.$.acwallet.account) == this.data.creator){
          console.log('this is my offer!');
          this.thisismyoffer = true;
        }
      }
      },

      claimOffer: function() {
        app.$.transact.claimOffer(this.key, function(e){
          console.log('offer claimed.', e);
        });
      },

      releaseOffer: function() {
        app.$.transact.releaseContract(this.key, function(e){
          console.log('offer released.', e);
        });
      },

      toHome: function() {
        app.set('route.path', localStorage.getItem('ac-lastroute'));
      },

      _is: function(a, b) {
        if (b === undefined){
          b = true;
        }
        //console.log(a ,'(',typeof a,') is',b,'(',typeof b,') they are equal for ==',a == b,', they are equal for ===',a === b);
        return a === b;
      },

      _getipfsurl: function(hash) {
        if(this.ipfsupload){
         var url = this.ipfsupload.url(hash);
         return url;
       }
      },



    });
  </script>
</dom-module>
