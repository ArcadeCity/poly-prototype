<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/ac-style/ac-style.html">
<link rel="import" href="../bower_components/ac-input/ac-input.html">
<link rel="import" href="../bower_components/ac-button/ac-button.html">
<link rel="import" href="../bower_components/ac-icon/ac-icon.html">
<link rel="import" href="./ac-helpers.html">
<link rel="import" href="./ac-sizeview.html">
<link rel="import" href="../bower_components/locals-whisperer/locals-whisperer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="./ac-config.html">


<dom-module id="ac-tokentransfer">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
/*        background-color: var(--locals-grey1);*/
        background-color: transparent;;
        --balance-h1: 40px;
        --balance-lineheight: 52px;
        --coin-margins: 0px 0px 7px 6px;
        --code-h2: 32px;
        --code-lineheight: 36px;
        --code-small: 10px;

      }

      h1 {
        @apply(--locals-font-h1);
        text-align: center;
        font-size: var(--balance-h1);
        line-height: var(--balance-lineheight);
      }


      h2 {
        @apply(--locals-font-h2);
        @apply(--opensans-semibold);
        font-size: var(--code-h2);
        line-height: var(--code-lineheight);
        color:var(--locals-blue);
      }

      p {
        @apply(--locals-font-body1);
      }

      small {
        @apply(--locals-font-small);
        @apply(--opensans-semibold);
        color:var(--locals-blue);
        font-size: var(--code-small);

      }


      .total {
        /*background-color: var(--locals-grey1);*/
        @apply(--layout-vertical);
      }

      .totalpart {
        box-sizing: border-box;
        padding: 0px 10vw 0px 10vw;
      }


      .topbar {
        width: 100%;
        background-color: transparent;
        height: var(--topbar-height);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        box-sizing: border-box;
        padding: 10px 20px 10px 20px;
        }

      .flex {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }




      .tussenschot {
        width: 100%;
        border: 0;
        margin: 0px;
        color: var(--locals-grey3);
        background-color: var(--locals-grey2);
        height: 1px;
      }

      .inbutton {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-end);
      }

     .coinbtn {
      margin-left: 5px;
     }

     #sendcoins {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
     }

     #receivecoins {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
     }

     .announce {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
/*      padding: 10px 0px 10px 0px;*/
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-start-justified);
      @apply(--layout-wrap);
     }


     .whitespace {
      height: 2vh;
     }

     .code {
      @apply(--layout-vertical);
      @apply(--layout-start);
      margin: 0px 20px 0px 0px;

     }

     .announce p {
      margin: 0px 20px 10px 0px;
     }

     .marginbtm {
      margin-left: 15px;
      margin: var(--coin-margins);
     }

     .temp {
      margin-top: 6vh;
      color: var(--locals-grey4);
     }

     .refresher {
        transition: all 1s linear;
     }


     .spinner {
      -webkit-animation: rotate 0.5s linear infinite;
      -moz-animation: rotate 0.5s linear infinite;
      animation: rotate 0.5s linear infinite;
     }


     .spinonce {
      -webkit-animation: rotate 0.5s linear infinite;
      -moz-animation: rotate 0.5s linear infinite;
      animation: rotate 0.5s linear infinite;

     }

      @-webkit-keyframes rotate {
          from {-webkit-transform: rotate(0deg);}
          to {-webkit-transform: rotate(180deg);}
      }

      @-moz-keyframes rotate {
          from {-moz-transform: rotate(0deg);}
          to {-moz-transform: rotate(180deg);}
      }

      @keyframes rotate {
          from {transform: rotate(0deg);}
          to {transform: rotate(180deg);}
      }


      .avatar {
        width:70px;
        height: 70px;
        border-radius: 50%;
        overflow: hidden;
        background-color: transparent;

      }

      .avatar img {
        width: 100%;
        height: 100%;
        border: none;

      }

    </style>

    <ac-helpers id="helpers"></ac-helpers>
    <ac-sizeview sizeview="{{sizeview}}"></ac-sizeview>
    <ac-config web3host="{{web3host}}" ipfs="{{ipfs}}" etherscanroot="{{etherscanroot}}"></ac-config>

    <locals-whisperer
    web3="{{web3}}"
    topic="{{topic}}"
    progress="{{progress}}"
    decimals="5"
    on-message-received="handlewhispermessage"
    id="whisper"></locals-whisperer>

    <div class="total">
      <div class="totalpart">
        <template is="dom-if" if="{{collsclosed}}">
            <ac-button small txtbtn txtcolor="base" on-tap="togglesendcoins"><div class="inbutton">send</div></ac-button>
            <ac-button small txtbtn txtcolor="base" on-tap="togglereceivecoins"><div class="inbutton">receive</div></ac-button>
        </template>
        <iron-collapse id="sendcoins">
        <template is="dom-if" if="{{_is(sendcoinstate,'first')}}">
          <div class="whitespace"></div>
          <ac-input class="sendinput" autofocus type="number" inputvalue="{{amount}}" bind-value="{{amount}}" label="Amount"></ac-input>
          <ac-input class="sendinput" autofocus type="number" inputvalue="{{pincode}}" bind-value="{{pincode}}" label="To"></ac-input>

          <ac-button small icon="declinenew" confirmsmall on-tap="togglesendcoins" class="closebtn"></ac-button>

          <ac-button small icon="ac-v" confirmsmall on-tap="toWaiting" class="closebtn"></ac-button>


        </template>

        <template is="dom-if" if="{{_is(sendcoinstate,'second')}}">
          <div class="announce">
          <div class="whitespace"></div>
          <p>Your transaction is being executed.</p>
          <ac-button small icon="declinenew" confirmsmall on-tap="togglesendcoins" class="closebtn"></ac-button>
          </div>
        </template>
        </iron-collapse>
        <iron-collapse id="receivecoins">
          <div class="code">
            <small>Temporary code</small>
            <h2>{{topic}}</h2>
          </div>
          <ac-button small icon="declinenew" confirmsmall on-tap="togglereceivecoins" class="closebtn"></ac-button>
        </iron-collapse>
        <div class="whitespace"></div>
        <div class="whitespace"></div>

      </div>
      <div class="tussenschot"></div>
      <div class="totalpart">
        <template is="dom-repeat" items="{{history}}">
          <div class="avatar" id="avatar">
            <img src="{{item.avatar}}">
          </div>
          <p><span>{{item.receiver}}</span> &Delta;<span>{{item.amount}}</span></p>
          <!-- <p class="temp">&Delta;<span>{{item.amount}}</span><span>{{item.receiver}}</span></p> -->
        </template>
      </div>


<!--     <div>
      <h1>E <span>{{ethbalance}}</span></h1>
      <h1>L <span>{{arcbalance}}</span></h1>
      <p on-tap="getLocalbalance">Refresh</p>
      <h1>Send funds to another locals user</h1>
      <p>enter the # of the other user</p>
      <ac-input autofocus bind-value="{{pincode}}" label="Pincode" center></ac-input>
      <locals-confirm on-confirm="toWaiting" type="next"></locals-confirm> -->

      <!-- Hier hebben we dan de key van de partner -->
      <!-- <p>TO: <span>{{partnerpubkey}}</span></p>
      <ac-button text on-tap="transfer">verstuur</locals-button> -->
    </div>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'ac-tokentransfer',

      properties: {
        foo: {
          type: String,
          value: 'ac-tokentransfer',
          notify: true
        },

        pincode: {
          observer: '_pincode'
        },

        sizeview: {
          type: String,
          observer: '_sizeview'
        },

        web3: {
          type: Object
        },

        sendcoinstate: {
          type: String,
          value: 'first',
          observer: '_sendcoinstate'
        },

        balanceloaded: {
          type: Boolean,
          value: false
        },

        topic: {
          type: Number,
        },

        collsclosed: {
          type: Boolean,
          value: true
        },

        history: {
          type: Array,
          value: []
        },



        contractaddr: {
          type: String,
          //value: '0xe94a4e5615E5d1BAfbDBc8a221D9b0995f67A752'
        },
        arcbalance: {
          type: Number,
          notify: true
        },
        ethbalance: {
          type: Number
        },

        pubkeys: {
          type: Array,
          value: [
         '0xcc27abf2528c7d37247f6faa4665314937dd8bd6',
         '0x539e9a8234ccdb48219dd69d6895231577877725',
         '0x2b037cd081eb9715c29ba144eb8eae286deccdfa',
         '0x12e2e8873e12e314e15e1c373a2bcd87543fef79',
         '0xbfe3fc7058f722b26d49a520c62f97764a58181f',
         '0x1ca4d1730facd0f3dfc1728fe0f1f951dc2fb7e4',
         '0x85daad51861607f1c8eb3844852c868f2a7ec8d9',
         '0x0652fdcbc99082195293a0a2220a4bb4b1b674a0',
         '0xab19d8249b6713af6f18c6b4ab964147b36241d9',
         '0x4f2dcf703652a55ed8bc1d4fc183ea08bee965f9',
         '0x31ef48bdf4afd5324eb1fb7f2595e3dd967f3489',
         '0x73e06a693f455e731b5116a4f441c29dc8cdd269',
         '0x8a21e09865bd6e5d018ceecde422d1c8bb465835',
         '0xae581423e0a94bad286b0926357a0999bd858d75',
         '0x1cd4faaf03717d4b68f63d077fa0b8134f4c2e46',
         '0x26bd23c3cf1d3877024d7dad3c8fef71796b3f65',
         '0x89636d1470f9d29e70ef606e3f2484ab1c588472',
         '0x4fa535145725c698e0cbca8b91e28afcf9d79be3',
         '0x452205ca702f3444034a11e266a39ee096ffd063',
         '0x19436c4a2619f8889e14908a6716825538d2a421',
         '0xb0a442efdf385a1c408f394e96be9d6b0da6ec50',
         '0xbf6df8ba333cee3754aa2636f278f01722b82eea',
         '0x82d2445c7dff4c35f3d09c3542b690f616ae9caf',
         '0x67606d59432f5fef62078f6ee68677df7418940f',
         '0x3fe98ec5bed5b4847af468a7b0944f9ab4444e71',
         '0x5e9df8b07db4b20de39d9dae2a9712538e22ec36',
         '0x894373f6edfcf9cef4628ab9a16169177b740416',
         '0xa43fb7eab26ce75d2faa8f8de6b8ff062268d7ff',
         '0xec7df12ebb888e1cd022255289d53669d56d763f',
         '0x31e03f63b26939e8e1a3c327b6286534aeff1d2c',
         '0x565d43c7b18826fe0d0dc509969c084f02293019',
         '0x1532a6d08afad52661cfd4a81ebf94b143a4f72d',
         '0xe2d77a795d959cd91b77df6e716a245c2e74874c',
         '0xc3cfc391fc8cf026d89cb125c30fd49b0f0f0290',
         '0x176b49348b60e3a469c2cc9b3b93678320b15bae',
         '0x03b9b659b8597b21e00bf838ae5d019aef7367c7',
         '0xd1678c8cd8c1279383f222a6ab44ff6139240b46',
         '0x3a6f7f490240e26777ecdab268f77baa2c6f714c',
         '0x31dc70687705e6e2e49ad4759474e7564aef0efe',
         '0xd2fc3949a76bc3e26be529badadb3a454df8b746',
         '0xcd04c4c4e7e7f02b8964e6468929591b0b1a9bd0',
         '0x1d6715f032ff41dc4ee3c0935c86533bed9004b0',
         '0x29d693f40d02742bbf7d94d38e32e6b5fb552025',
         '0x476e18e94c7977df7170ecdf98956119572e07a4',
         '0xb5aaa79a6c8301b68b9bd0588aa3f0de49ce22ce',
         '0x09770b4c0fa5794c85e2b3c340a3c7f35df56855',
         '0x3e2bab1676b7b0aa3c7ef3ce40cb84b3098b63db',
         '0x2304d369204e7ab6497396934146f03454d74b16',
         '0xa54fd10ab7a38c56fc5e8d8dc5838fe812b47e7e']
        }
      },

      _pincode: function() {
        console.log(this.pincode);
      },

      ready: function(){
        this._getARCbalance();
        var self = this;

        window.setInterval(function(){
          self._getARCbalance();
        }, 5000);

        this.sendcoinstate = 'first';
        this.password = sessionStorage.getItem('ac-password');
      },

      attached: function(){
        var self=this;
      },


      handlewhispermessage: function(m) {
        var self = this;
        var message = JSON.parse(m.detail.message);
        switch (message.command) {
          case 'requestpubkeyforlocalstransfer':
            self.$.whisper.whisperpost(m.detail.from, JSON.stringify({
              'command': 'sendpubkey',
              'pubkey': self.account
            }));
            break;
          case 'sendpubkey':
            console.log('Send ARC to ', message.pubkey);
            this.transfer(this.amount * 100, this.$.helpers.fixaddress(message.pubkey), function(err, result) {
              console.log('Transfer started. Sending confirmation to ',m.from);
              self.$.whisper.whisperpost(m.from, JSON.stringify({
                'command': 'confirmtransfer',
                'amount': self.amount * 100
              }));
            });
            //var username = //self._getUsername(message.pubkey,function(username, avatarurl){

            break;
          case 'confirmtransfer':
            // TODO : show transfer in history...
            console.log('transfer confirmed...', message.amount / 100, 'received');
            var dia = document.querySelector('#dia');
            var stringske = 'Transfer confirmed ' + message.amount / 100 + 'Δ';


            break;
          default:
            console.log('unknown message', message);
        }
      },



      toWaiting: function(){
        var self = this;
        //debugger;
        //this.handler = document.querySelector('locals-verification-validator');
        console.log('wallet: ',this.$.whisper.topic);
        //debugger;
        this.$.whisper.whisperpost(this.pincode, JSON.stringify({
                'command': 'requestpubkeyforlocalstransfer',
              }));
        this.state = 'waiting';

        this.sendcoinstate = 'second';
      },

      clearInputs: function(){
        this.pincode = '';
        this.amount = '';
        console.log("Cleared inputs!!!!!! PINCODE=",this.pincode,' & AMOUNT=',this.amount);
      },

      refreshBalance:function() {
        this.spinclass = 'spinonce';
        this._getARCbalance();
        var self = this;
        setTimeout(function(){
            self.spinclass = '';
        },500)
      },

      _getARCbalance: function() {
        console.log('ac-tokentransfer ', Date.now());
        this.contracturl = this.resolveUrl('./contracts/ARCToken.json');

        var self = this;

        this.importHref(this.contracturl, function(e) {
          var contractjson = JSON.parse(e.target.import.body.innerText);
          var tokenContract = self.web3.eth.contract(contractjson.abi);
          var tokenContractInstance = tokenContract.at(contractjson.address);
          var account = self.$.helpers.fixaddress(self.account);
          self.arcbalance = tokenContractInstance.balanceOf(account) / 1e18;
          self.balanceloaded = true;
          self.fire('balance-loaded');
          self.fire('map-update');
        });

      },

      transfer: function(amount,pubkey,cb){
        //debugger;
        // we gaan dan wat geld versjassen
        //this.amount = 1;
        var self = this;

        this.contracturl = this.resolveUrl('./contracts/ARCToken.json');
        this.importHref(this.contracturl, function(e) {
          this.contractjson = JSON.parse(e.target.import.body.innerText);
             self.web3.eth.getGasPrice(function(err, result){
            var gasPrice = result.toNumber(10);
          console.log('gasprice: ', gasPrice);

          var MyContract = self.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddr);
            console.log('doing transfer of ',amount,' LC to: ', pubkey, 'from: ', self.account);
            myContractInstance.transfer.sendTransaction(pubkey, amount, {
              from: self.$.helpers.fixaddress(self.account),
              gasPrice: gasPrice,
              gasLimit: 3000000,
              gas: 2000000
            }, function(err, result){
              console.log(err, result);
              var coinbalance = myContractInstance.balanceOf(self.$.helpers.fixaddress(self.account));
                self.arcbalance = coinbalance;
                if (cb){
                  cb(err,result);
                }
            });

          });
          //this.web3.send(this.partnerpubkey, this.amount);
        });


        this.clearInputs();
        var sendcoins = self.$.sendcoins;
        sendcoins.toggle();
        this.collsclosed=!this.collsclosed;

        this.sendcoinstate = 'first';
      },

    toHome: function() {
      this.fire('to-home');
    },

    _sizeview: function(){
      switch(this.sizeview) {
          case 'phone':
              this.customStyle['--balance-h1'] = '40px';
              this.customStyle['--balance-lineheight'] = '52px';
              this.customStyle['--code-h2'] = '32px';
              this.customStyle['--code-lineheight'] = '36px';
              this.customStyle['--code-small'] = '10px';
              this.customStyle['--coin-margins'] = '0px 0px 7px 6px';
                this.customStyle['--topbar-height'] = '100px';
              this.updateStyles();
              break;
          case 'desktop':
              this.customStyle['--balance-h1'] = '60px';
              this.customStyle['--balance-lineheight'] = '78px';
              this.customStyle['--code-h2'] = '44px';
              this.customStyle['--code-lineheight'] = '50px';
              this.customStyle['--code-small'] = '12px';
              this.customStyle['--coin-margins'] = '0px 0px 10px 6px';
                this.customStyle['--topbar-height'] = '100px';
              this.updateStyles();
              break;
          case 'xlarge':
              this.customStyle['--balance-h1'] = '120px';
              this.customStyle['--balance-lineheight'] = '152px';
              this.customStyle['--code-h2'] = '98px';
              this.customStyle['--code-lineheight'] = '104px';
              this.customStyle['--code-small'] = '24px';
              this.customStyle['--coin-margins'] = '0px 0px 20px 6px';
                this.customStyle['--topbar-height'] = '100px';
              this.updateStyles();
              break;
          default:
          console.log("!!! ** Niks");
      }
    },


    _is: function(a, b) {
      if (b === undefined){
        b = true;
      }
      //console.log(a ,'(',typeof a,') is',b,'(',typeof b,') they are equal for ==',a == b,', they are equal for ===',a === b);
      return a === b;
    },

      togglesendcoins: function() {
        var sendcoins = this.$.sendcoins;
        sendcoins.toggle();
        this.collsclosed=!this.collsclosed;
        this.sendcoinstate = 'first';
      },

      togglereceivecoins: function() {
        // this.whisper = this.$.whisper;
        // this.topic = this.whisper.topic;
        // console.log("******** topic in wallet: ****",this.topic)
        var receivecoins = this.$.receivecoins;
        receivecoins.toggle();
        this.collsclosed=!this.collsclosed;
      },


      _sendcoinstate: function(){
        // console.log('********************* !!!! SENCOINSTATE', this.sendcoinstate);
      }





    });
  })();
  </script>
</dom-module>
