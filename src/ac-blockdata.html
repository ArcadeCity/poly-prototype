<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/web3-wallet/web3-wallet.html">
<link rel="import" href="./ac-ipfs.html">
<link rel="import" href="./ac-config.html">

<dom-module id="ac-blockdata">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-localstorage
  name="ac-blockdata"
  value="{{blockdata}}"
  on-iron-localstorage-load-empty="initblockarray"
  on-iron-localstorage-load="loadblockarray"
  ></iron-localstorage>

    <iron-localstorage
    name="ac-lastblock"
    value="{{lastblock}}"
    on-iron-localstorage-load-empty="initlastblock"
    on-iron-localstorage-load="loadlastblock"
    ></iron-localstorage>

    <web3-wallet
      id="web3wallet"
      account="{{account}}"
      password="1234"
      balance="{{balance}}"
      keystore="{{keystore}}"
      walletname="ac-wallet"
      host="{{web3host}}"
      web3="{{web3}}"></web3-wallet>

    <ac-config web3host="{{web3host}}"></ac-config>
    <ac-password password="{{password}}"></ac-password>

    <ac-ipfs id="ipfs"></ac-ipfs>

  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'ac-blockdata',
      properties: {
        web3: {
          type: Object,
          observer: '_web3'
        },
        blockdata: {
          type: Array,
          notify: true,
          observer: '_blockdata'
        },
        blockobject: {
          type: Object,
          observer: '_blockobject'
        }
      },

      attached: function() {
        console.log('ac-blockdata attached');
//        this.password = sessionStorage.getItem('ac-password');
      },

      _blockdata: function() {
        console.log(this.blockdata);
      },

      detached: function(){
        if (this.eventwatcher){
          try{
            this.eventwatcher.stopWatching();
          }catch(e){
            console.log('ac-blockdata: error stopWatching',e);
          }
        }
      },

      _web3: function() {
        console.log('got web3');
        this.getBlockData();
      },

      _blockobject: function() {
        console.log(this.blockobject);
      },

      initlastblock: function(){
        this.lastblock = 1759875;
        this.getBlockData();
      },

      loadlastblock: function(){
        console.log('CACHE: found lastblock in localstorage',this.lastblock);
        this.getBlockData();
      },

      initblockarray: function() {
        this.blockdata = [];
        this.blockobject = {};
        this.getBlockData();
      },

      loadblockarray: function(){
        var tmpblockobject = {}
        for (var i = 0, len = this.blockdata.length; i < len; i++) {
          tmpblockobject[this.blockdata[i].offerid] = i;
        }
        console.log('CACHE: found blockdata in localstorage',this.blockdata.length,'items');
        this.blockobject = tmpblockobject;
        this.getBlockData();
      },

      setFilter: function() {
        this.fire('newblock');
        var self = this;
        var filter = this.web3.eth.filter('latest').watch(function(err, blockHash) {
          self.fire('newblock');
          var block = self.web3.eth.getBlock(blockHash);
          self.block = block;
        });
      },

      getBlockData: function(){
          console.log('getting block data');
          //check if all needed data items are in place.
          if (!this.web3 || !this.blockobject || !this.lastblock ){
            console.log('something wrong with blockdata');
            return;
          }

          // if already started - then just skip ( avoid listening twice to BC)
          if (this.getblockdata === true){
            console.log('already trye');
            return;
          }

          //this.getblockdata = true;
          console.log('Starting getBlockData at block',this.lastblock);

          var self = this;
          //debugger;
          //app.helpers.getfile('./contracts/localsInOut.json', function(err, inoutcontractjson) {

            // var MyContract = self.web3.eth.contract(inoutcontractjson.abi);
            // var myContractInstance = MyContract.at(inoutcontractjson.address);

            var MyContract = self.web3.eth.contract([{"constant":true,"inputs":[],"name":"REPcontract","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"ARCTokencontractAddress","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"offerid","type":"uint256"}],"name":"claim","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"offers","outputs":[{"name":"creator","type":"address"},{"name":"amount","type":"uint256"},{"name":"descriptionipfs","type":"string"},{"name":"status","type":"uint256"},{"name":"tagcontract","type":"address"},{"name":"escrowaddress","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"ipfshash","type":"string"}],"name":"ipfstoid","outputs":[{"name":"offerid","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"offerid","type":"uint256"}],"name":"confirm","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"numOffers","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_repcoinaddress","type":"address"},{"name":"_amount","type":"uint256"},{"name":"_descriptionipfs","type":"string"}],"name":"newOffer","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"inputs":[{"name":"_ARCTokencontract","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"offerID","type":"uint256"},{"indexed":false,"name":"creator","type":"address"},{"indexed":false,"name":"ipfsdescr","type":"string"},{"indexed":false,"name":"escrowaddress","type":"address"},{"indexed":false,"name":"repaddress","type":"address"}],"name":"OfferAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"offerID","type":"uint256"},{"indexed":false,"name":"creator","type":"address"},{"indexed":false,"name":"ipfsdescr","type":"string"},{"indexed":false,"name":"claimer","type":"address"},{"indexed":false,"name":"escrowaddress","type":"address"},{"indexed":false,"name":"repaddress","type":"address"}],"name":"OfferClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"offerID","type":"uint256"},{"indexed":false,"name":"creator","type":"address"},{"indexed":false,"name":"ipfsdescr","type":"string"}],"name":"OfferReleased","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"offerID","type":"uint256"},{"indexed":false,"name":"creator","type":"address"},{"indexed":false,"name":"ipfsdescr","type":"string"},{"indexed":false,"name":"claimer","type":"address"},{"indexed":false,"name":"escrowaddress","type":"address"},{"indexed":false,"name":"repaddress","type":"address"}],"name":"OfferConflict","type":"event"}]);
            var myContractInstance = MyContract.at("0xeb6c58765c03d862efb3c6bd49550122267b469d");

            self.eventwatcher = myContractInstance.allEvents({
              fromBlock: self.lastblock,
            });

            self.eventwatcher.watch(function(error, result) {
              var event = result;

              switch (event.event) {

                case 'OfferAdded':
                console.log('offer added in ', event.blockNumber);
                var offerid = event.args.offerID.toNumber();

                //var offerid = event.args.offerID.toNumber();
                var point = {
                  escrowaddress: event.args.escrowaddress,
                  offerid: event.args.offerID.toNumber(),
                  ipfshash: event.args.ipfsdescr,
                  repaddress: event.args.repaddress,
                  creator: event.args.creator,
                  status: 'added'
                };

                // resolve IPFS data
                self.$.ipfs.cat(event.args.ipfsdescr, function(err, data) {
                  point.ipfsdata = JSON.parse(data);

                  self.lastblock = event.blockNumber + 1;

                  if (!self.blockobject[event.args.offerID.toNumber()]) {
                    self.blockobject[event.args.offerID.toNumber()] = self.blockdata.length;
                    self.push('blockdata', point);
                  }
                });

                // claim events from (too) old are ignored
                // if (!self.blockdata[self.blockobject[offerid]]){
                //   return;
                // }
                  self.blockdata[self.blockobject[offerid]].status = 'added';
                  self.lastblock = event.blockNumber+1;
                  break;

                case 'OfferClaimed':
                console.log('offer claimed in ', event.blockNumber);
                var offerid = event.args.offerID.toNumber();

                //var offerid = event.args.offerID.toNumber();
                var point = {
                  escrowaddress: event.args.escrowaddress,
                  offerid: event.args.offerID.toNumber(),
                  ipfshash: event.args.ipfsdescr,
                  repaddress: event.args.repaddress,
                  creator: event.args.creator,
                  status: 'claimed'
                };

                // resolve IPFS data
                self.$.ipfs.cat(event.args.ipfsdescr, function(err, data) {
                  point.ipfsdata = JSON.parse(data);

                  self.lastblock = event.blockNumber + 1;

                  if (!self.blockobject[event.args.offerID.toNumber()]) {
                    self.blockobject[event.args.offerID.toNumber()] = self.blockdata.length;
                    self.push('blockdata', point);
                  }
                });

                  break;

                case 'OfferReleased':
                console.log('offer released in ', event.blockNumber);
                var offerid = event.args.offerID.toNumber();

                //var offerid = event.args.offerID.toNumber();
                var point = {
                  escrowaddress: event.args.escrowaddress,
                  offerid: event.args.offerID.toNumber(),
                  ipfshash: event.args.ipfsdescr,
                  repaddress: event.args.repaddress,
                  creator: event.args.creator,
                  status: 'released'
                };

                // resolve IPFS data
                self.$.ipfs.cat(event.args.ipfsdescr, function(err, data) {
                  point.ipfsdata = JSON.parse(data);

                  self.lastblock = event.blockNumber + 1;

                  if (!self.blockobject[event.args.offerID.toNumber()]) {
                    self.blockobject[event.args.offerID.toNumber()] = self.blockdata.length;
                    self.push('blockdata', point);
                  }
                });

                  break;

                case 'OfferConflict':
                  break;
                default:
                  console.log('unknown event', event.event);
              }
            });
          // });
      }


    });
  </script></dom-module>
