<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/web3-wallet/web3-wallet.html">

<dom-module id="ac-blockdata">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
      :host {
        display: block;

        padding: 16px;
      }
    </style>

    <iron-localstorage
  name="ac-blockdata"
  value="{{blockdata}}"
  on-iron-localstorage-load-empty="initblockarray"
  on-iron-localstorage-load="loadblockarray"
  ></iron-localstorage>

  <iron-localstorage
    name="ac-lastblock"
    value="{{lastblock}}"
    on-iron-localstorage-load-empty="initlastblock"
    on-iron-localstorage-load="loadlastblock"
    ></iron-localstorage>

    <web3-wallet
      id="web3wallet"
      walletname="locals-wallet"
      account="{{account}}"
      password="{{password}}"
      balance="{{balance}}"
      keystore="{{keystore}}"
      host="https://eth.arcadecity.world:8545"
      web3="{{web3}}"></web3-wallet>

  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'ac-blockdata',
      properties: {
        web3: {
          type: Object,
          observer: '_web3'
        },
        blockdata: {
          type: Array,
          notify: true
        }
      },

      attached: function() {
        console.log('blockdata attached');
        this.password = sessionStorage.getItem('ac-password');
      },

      _web3: function() {
        console.log('got web3');
      },

      initlastblock: function(){
        this.lastblock = 1759875;
        this.getBlockData();
      },

      loadlastblock: function(){
        console.log('CACHE: found lastblock in localstorage',this.lastblock);
        this.getBlockData();
      },

      initblockarray: function() {
        this.blockdata = [];
        this.blockobject = {};
        this.getBlockData();
      },

      loadblockarray: function(){
        var tmpblockobject = {}
        for (var i = 0, len = this.blockdata.length; i < len; i++) {
          tmpblockobject[this.blockdata[i].offerid] = i;
        }
        console.log('CACHE: found blockdata in localstorage',this.blockdata.length,'items');
        this.blockobject = tmpblockobject;
        this.getBlockData();
      },

      setFilter: function() {
        this.fire('newblock');
        var self = this;
        var filter = this.web3.eth.filter('latest').watch(function(err, blockHash) {
          self.fire('newblock');
          var block = self.web3.eth.getBlock(blockHash);
          self.block = block;
        });
      },

      getBlockData: function(){

          // if (this.getblockdata === true){
          //   return;
          // }
          //
          // if (!this.web3 || !this.blockobject || !this.lastblock ){
          //   return;
          // }

          this.getblockdata = true;
          console.log('Starting getBlockData');


          var self = this;
          //self.web3 = self.$.web3wallet.web3;



          app.helpers.getfile('/src/contracts/localsInOut.json', function(err, inoutcontractjson) {

            var MyContract = self.web3.eth.contract(inoutcontractjson.abi);
            var myContractInstance = MyContract.at(inoutcontractjson.address);

            var events = myContractInstance.allEvents({
              fromBlock: self.lastblock,
            });

            events.watch(function(error, result) {

              var event = result;
              switch (event.event) {
                case 'OfferAdded':

                  //var offerid = event.args.offerID.toNumber();
                  var point = {
                    escrowaddress: event.args.escrowaddress,
                    offerid: event.args.offerID.toNumber(),
                    ipfshash: event.args.ipfsdescr,
                    repaddress: event.args.repaddress,
                    creator: event.args.creator,
                    status: 'added'
                  };

                  self.lastblock = event.blockNumber+1;

                  if (!self.blockobject[event.args.offerID.toNumber()]){
                    self.blockobject[event.args.offerID.toNumber()] = self.blockdata.length;
                    self.push('blockdata', point);
                  }


                  break;
                case 'OfferClaimed':
                  var offerid = event.args.offerID.toNumber();
                  self.blockdata[self.blockobject[offerid]].status = 'claimed';
                  self.lastblock = event.blockNumber+1;
                  break;

                case 'OfferReleased':
                case 'OfferConflict':
                default:
                  console.log('unknown event', event.event);
                  break;
              }
            });
          });
      },

      setPass: function(){
        sessionStorage.setItem('lopassword', this.passwd);
        this.$.lsapi.privatekey = this.passwd;
        this.$.web3wallet.password = this.passwd;
        Excess.RouteManager.transitionTo('/home');
      },

      _gotpassword: function(){
          this.wrongpass = false;
        this.$.web3wallet.password = this.passwd;
        console.log('go home');
        sessionStorage.setItem('lopassword', this.passwd);
        if (window.location.hash === ''){
          //Excess.RouteManager.transitionTo('/home');
        }
      },

      _wrongpassword: function(){
          Excess.RouteManager.transitionTo('/enterpass');
          if(this.$.lsapi.privatekey){
            console.log("ISSEM FOUT???????", this.wrongpass);
          this.wrongpass = true;

          }

      }
    });
  </script>
</dom-module>
