<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/leaflet-map/leaflet-map.html">
<link rel="import" href="./ac-blockdata.html">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js"></script>

<dom-module id="ac-map">
  <!-- Defines the element's style and local DOM -->
  <template>

    <style>
    :host {
      display: block;
      height: 100%;
      @apply(--base-structure);
    }

    leaflet-map {
      width: 100vw;
      height: 87vh;
      z-index: 1;
    }

  .spinnerdiv {
    width: 100%;
    height: 100%;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
  }

  .refresher {
       -webkit-animation-name: rotate;
      -webkit-animation-duration: 1s;
      -webkit-animation-iteration-count: infinite;
      -webkit-animation-timing-function: linear;
      -moz-animation-name: rotate;
      -moz-animation-duration: 1s;
      -moz-animation-iteration-count: infinite;
      -moz-animation-timing-function: linear;
      animation-name: rotate;
      animation-duration: 1s;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
      opacity: 0.5;
     }

      @-webkit-keyframes rotate {
          from {-webkit-transform: rotate(0deg);}
          to {-webkit-transform: rotate(360deg);}
      }

      @-moz-keyframes rotate {
          from {-moz-transform: rotate(0deg);}
          to {-moz-transform: rotate(360deg);}
      }

      @keyframes rotate {
          from {transform: rotate(0deg);}
          to {transform: rotate(360deg);}
      }

      ac-button {
    width: 80px;
    height: 80px;
    position: fixed;
    bottom: 40px;
    right: 40px;
    z-index: 1;
  }



    </style>

    <div id="spinner" hidden$="{{!locationunknown}}" class="spinnerdiv">
      <ac-icon class="refresher" icon="refresh1" iconcolor="pink"></ac-icon>
		</div>

    <ac-button on-tap="toList" icon="ac-hashtagbolder" bg="red" txtcolor="white"></ac-button>

    <leaflet-map
      id="leafletmap"
      draggable
      latitude="{{latitude}}"
      longitude="{{longitude}}"
      no-Zoom-Control="true"
      min-zoom="8"
      max-zoom="17"
      zoom="16">

      <leaflet-geolocation
        id="geolocation"
        on-locationfound="locationfound"
        enable-high-accuracy
        latitude="{{latitude}}"
        longitude="{{longitude}}"
        accuracy="3">
      </leaflet-geolocation>

      <leaflet-tilelayer
        url="//1.base.maps.cit.api.here.com/maptile/2.1/maptile/newest/normal.day/{z}/{x}/{y}/256/png8?app_id=s6z9incVaWY1oE3SoBol&app_code=iJKI11eGupM_wnz2_EQ2Kg" max-zoom="19">
      </leaflet-tilelayer>

      <template is="dom-repeat" items="{{blockdata}}">
        <leaflet-marker
          on-tap="selectoffer"
          ipfshash="{{item.ipfshash}}"
          title="{{item.ipfshash}}"
          icon="car"
          latitude="{{item.latitude}}"
          longitude="{{item.longitude}}">
        </leaflet-marker>
      </template>
      
    </leaflet-map>

    <ac-blockdata name="blockdata" blockdata="{{blockdata}}"></ac-blockdata>

  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'ac-map',

      properties: {
        locationunknown: {
            type: Boolean,
            value: true
        },
        blockdata: {
          type: Array,
          observer: '_blockdata'
        }
      },

      attached: function() {
        this.locationunknown = true;
      },

      _blockdata: function() {
        var blockdata = this.blockdata;
        console.log(blockdata);
        for (var i = 0; i < blockdata.length; i++) {
          blockdata[i];
        }
      },

      toList: function() {
        app.set('route.path', '/list/');
      },

      locationfound: function() {
        this.locationunknown = false;
        // this.$.spinner.hidden = true;
        // console.log('location found: ', this.locationunknown);
        // this.$.leafletmap.hidden = false;
        this.$.leafletmap.map.invalidateSize();
      }
    });
  </script>
</dom-module>
